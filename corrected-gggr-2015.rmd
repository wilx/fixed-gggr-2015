---
title: "Corrected Global Gender Gap Report 2015"
author: "Václav Haisman"
date: "March 1, 2016"
toc: true
output: 
  pdf_document: 
    latex_engine: xelatex
    number_sections: true
language: english
geometry:
    - a4paper
    - margin=2cm
mainfont: TeX Gyre Schola
---

```{r, echo=FALSE}
library(knitr)

linechart <- function(origData, correctedData, chartLabel) {
  frame()
  stripchart(origData, method = "stack",# jitter = 0.1, offset = 1/3,
             vertical = FALSE, add = FALSE,
             at = NULL, xlim = c(0,1), ylim = NULL,
             main = chartLabel, family = "serif", ylab = "", xlab = "ratio",
             log = "", cex.main = 0.8, col="blue", pch=1)
  stripchart(correctedData, method = "stack",# jitter = 0.1, offset = 1/3,
             vertical = FALSE, add = TRUE,
             at = NULL, xlim = c(0,1), ylim = NULL,
             ylab = "", xlab = "",
             log = "", cex.main = 0.8,  col="green", pch=2)
  legend("bottomleft", legend = c("original", "corrected"), col=c("blue", "green"), pch=c(1,2))
}

addMoreInfoColumns <- function(dataFrame) {
  dataFrame$cRank <- rank(-dataFrame$cRatio, na.last = TRUE, ties.method = "min")
  dataFrame$change <- ifelse(dataFrame$cRank <= dataFrame$rank,
                             ifelse(dataFrame$cRank < dataFrame$rank,
                                    sprintf("↑%d", dataFrame$rank - dataFrame$cRank),
                                    "="),
                             sprintf("↓%d", dataFrame$cRank - dataFrame$rank))
  dataFrame <- dataFrame[order(dataFrame$cRank, na.last = TRUE), , drop = FALSE]
  return(dataFrame)
}

printTable <- function(dataFrame) {
  kable(dataFrame, digits = 2, row.names = FALSE)
}

```

# Corrected Global Gender Gap Report 2015

Why am I doing this?

:   Because the [Global Gender Gap Report](http://reports.weforum.org/global-gender-gap-report-2015/)
    and its indexes does not accurately reflect gender
    gaps that favour females. Ranks and indexes of some of the countries will be significantly different
    if the gap is penalized both when it favours males and when it favours females.
    
How does this differ from the original report?

:   Whenever there is inequality (gap) affecting males favouring females, the original report
    truncates any ratio at value 1. In this report, table colum cRatio (corrected ratio) is 
    calculated as inverse value ($\frac{1}{ratio}$) of the original ratio. There is also new column
    cRank (corrected rank) which shows ranking of the countries using the cRatio column.
    
How was this PDF produced?

:   This PDF was produced by use of several tools: `pdftohtml`, Perl, R, RStudio and RMarkdown.
    See [Appendix 1](#appendix-1) for details. There is GitHub repository
    [`wilx/fixed-gggr-2015`](https://github.com/wilx/fixed-gggr-2015) that contains all the necessary
    sources and generated files to build this PDF file, except for the original 
    Global Gender Gap Report 2015 PDF file.

## Economic participation and opportunity

```{r, echo=FALSE}
labForcePart <- read.csv2(file = "Labour-force-participation.csv",
                   sep = ",", quote = "\"", header = FALSE, dec = ".", na.strings = c("—"),
                   col.names = c("country", "female", "male", "FM", "FMT", "rank", "cRatio"))
labForcePart <- addMoreInfoColumns(labForcePart)

wageEq <- read.csv2(file = "Wage-equality-survey.csv",
                   sep = ",", quote = "\"", header = FALSE, dec = ".", na.strings = c("—"),
                   col.names = c("country", "survey data", "FM", "FMT", "rank", "cRatio"))
wageEq <- addMoreInfoColumns(wageEq)

estEarnedIncome <- read.csv2(file = "Estimated-earned-income.csv",
                   sep = ",", quote = "\"", header = FALSE, dec = ".", na.strings = c("—"),
                   col.names = c("country", "female", "male", "female cut-off", "male cut-off", "FMT", "rank"))

legSenMan <- read.csv2(file = "Legislators,-senior-officials-and-managers.csv",
                   sep = ",", quote = "\"", header = FALSE, dec = ".", na.strings = c("—"),
                   col.names = c("country", "female", "male", "FM", "FMT", "rank", "cRatio"))
legSenMan <- addMoreInfoColumns(legSenMan)

techWorkers <- read.csv2(file = "Professional-and-technical-workers.csv",
                   sep = ",", quote = "\"", header = FALSE, dec = ".", na.strings = c("—"),
                   col.names = c("country", "female", "male", "FM", "FMT", "rank", "cRatio"))
techWorkers <- addMoreInfoColumns(techWorkers)

```

### Labour force participation

````{r, echo=FALSE}
printTable(labForcePart)
````

````{r, echo=FALSE, fig.align='center'}
linechart(labForcePart$FMT, labForcePart$cRatio, "Labour force participation")
````

### Wage equality

````{r, echo=FALSE}
printTable(wageEq)
````

````{r, echo=FALSE, fig.align='center'}
linechart(wageEq$FMT, wageEq$cRatio, "Wage equality")
````


### Estimated earned income

````{r, echo=FALSE}
printTable(estEarnedIncome)
````

### Legislators, senior officials and managers

````{r, echo=FALSE}
printTable(legSenMan)
````

````{r, echo=FALSE, fig.align='center'}
linechart(legSenMan$FMT, legSenMan$cRatio, "Legislators, senior officials and managers")
````


### Professional and technical workers

````{r, echo=FALSE}
printTable(techWorkers)
````

````{r, echo=FALSE, fig.align='center'}
linechart(techWorkers$FMT, techWorkers$cRatio, "Professional and technical workers")
````


## Education attainment

```{r, echo=FALSE}
primEd <- read.csv2(file = "Enrolment-in-primary-education.csv",
                   sep = ",", quote = "\"", header = FALSE, dec = ".", na.strings = c("—"),
                   col.names = c("country", "female", "male", "FM", "FMT", "rank", "cRatio"))
primEd <- addMoreInfoColumns(primEd)

secEd <- read.csv2(file = "Enrolment-in-secondary-education.csv",
                   sep = ",", quote = "\"", header = FALSE, dec = ".", na.strings = c("—"),
                   col.names = c("country", "female", "male", "FM", "FMT", "rank", "cRatio"))
secEd <- addMoreInfoColumns(secEd)

terEd <- read.csv2(file = "Enrolment-in-tertiary-education.csv",
                   sep = ",", quote = "\"", header = FALSE, dec = ".", na.strings = c("—"),
                   col.names = c("country", "female", "male", "FM", "FMT", "rank", "cRatio"))
terEd <- addMoreInfoColumns(terEd)

literacy <- read.csv2(file = "Literacy-rate.csv",
                   sep = ",", quote = "\"", header = FALSE, dec = ".", na.strings = c("—"),
                   col.names = c("country", "female", "male", "FM", "FMT", "rank", "cRatio"))
literacy <- addMoreInfoColumns(literacy)

```

### Literacy

````{r, echo=FALSE}
printTable(literacy)
````

````{r, echo=FALSE, fig.align='center'}
linechart(literacy$FMT, literacy$cRatio, "Literacy")
````


### Primary education enrollment

````{r, echo=FALSE}
printTable(primEd)
````

````{r, echo=FALSE, fig.align='center'}
linechart(primEd$FMT, primEd$cRatio, "Primary education enrollment")
````


### Secondary education enrollment

````{r, echo=FALSE}
printTable(secEd)
````

````{r, echo=FALSE, fig.align='center'}
linechart(secEd$FMT, secEd$cRatio, "Secondary education enrollment")
````

### Tertiary education enrollment

````{r, echo=FALSE}
printTable(terEd)
````

````{r, echo=FALSE, fig.align='center'}
linechart(terEd$FMT, terEd$cRatio, "Tertiary education enrollment")
````

## Health and survival

```{r, echo=FALSE}
birthRatio <- read.csv2(file = "Sex-ratio-at-birth.csv",
                   sep = ",", quote = "\"", header = FALSE, dec = ".", na.strings = c("—"),
                   col.names = c("country", "female", "male", "FMT", "rank"))

healthyLife <- read.csv2(file = "Healthy-life-expectancy.csv",
                   sep = ",", quote = "\"", header = FALSE, dec = ".", na.strings = c("—"),
                   col.names = c("country", "female", "male", "FM", "FMT", "rank", "cRatio"))
healthyLife <- addMoreInfoColumns(healthyLife)
```

### Sex ratio at birth

````{r, echo=FALSE}
printTable(birthRatio)
````

````{r, echo=FALSE, fig.align='center'}
linechart(birthRatio$FMT, birthRatio$FMT, "Sex ratio at birth")
````

### Healthy life expectancy

````{r, echo=FALSE}
printTable(healthyLife)
````

````{r, echo=FALSE, fig.align='center'}
linechart(healthyLife$FMT, healthyLife$cRatio, "Sex ratio at birth")
````

## Political empowerment

```{r, echo=FALSE}
womenInParliament <- read.csv2(file = "Women-in-parliament.csv",
                   sep = ",", quote = "\"", header = FALSE, dec = ".", na.strings = c("—"),
                   col.names = c("country", "female", "male", "FM", "FMT", "rank", "cRatio"))
womenInParliament <- addMoreInfoColumns(womenInParliament)

womenMinisters <- read.csv2(file = "Women-in-ministerial-positions.csv",
                   sep = ",", quote = "\"", header = FALSE, dec = ".", na.strings = c("—"),
                   col.names = c("country", "female", "male", "FM", "FMT", "rank", "cRatio"))
womenMinisters <- addMoreInfoColumns(womenMinisters)

femaleHeadOfState <- read.csv2(file = "Years-with-female-head-of-state.csv",
                   sep = ",", quote = "\"", header = FALSE, dec = ".", na.strings = c("—"),
                   col.names = c("country", "female", "male", "FM", "FMT", "rank", "cRatio"))
femaleHeadOfState <- addMoreInfoColumns(femaleHeadOfState)
```


### Women in parliament

````{r, echo=FALSE}
printTable(womenInParliament)
````

````{r, echo=FALSE, fig.align='center'}
linechart(womenInParliament$FMT, womenInParliament$cRatio, "Women in parliament")
````

### Women in ministerial positions

````{r, echo=FALSE}
printTable(womenMinisters)
````

````{r, echo=FALSE, fig.align='center'}
linechart(womenMinisters$FMT, womenMinisters$cRatio, "Women in ministerial positions")
````

### Years with female head of state

````{r, echo=FALSE}
printTable(femaleHeadOfState)
````

````{r, echo=FALSE, fig.align='center'}
linechart(femaleHeadOfState$FMT, femaleHeadOfState$cRatio, "Years with female head of state")
````


# Appendix 1 {#appendix-1}

The following Perl script was used to scrape Global Gender Gap Report PDF file and produce separate CSV for each table:

```perl
use strict;
use XML::XPath;
use XML::XPath::XMLParser;
use Text::CSV::Encoded;
use IO::File;
use IO::Handle;
use Regexp::Common;
use Data::Dumper;

binmode(STDOUT, ":encoding(UTF-8)");

my $inputf = IO::File->new();
$inputf->open("gggr.xml", "<");
$inputf->binmode(":encoding(UTF-8)");
my $xp = XML::XPath->new($inputf);
my $pages = $xp->find('//page');

foreach my $page ($pages->get_nodelist) {
    my @table_title_nodes = $page->find('./text[@font = \'1\']')->get_nodelist;
    my $table_title = $table_title_nodes[0]->string_value;
    print STDERR "table title: ", $table_title, "\n";
    my @value_nodes = $page->find('./text[@font = \'5\' and @height = \'10\']'
                                  . '| ./text[@font = \'7\' and @height = \'11\']')->get_nodelist;
    my @value_text = map {$_->string_value} @value_nodes;

    # Count from 2nd element all elements that are numbers. This will be the
    # column count for this table.

    my $columns;
    for ($columns = 0; $value_text[$columns + 1] =~ /^\d/; ++$columns)
    {}
    ++$columns;
    print STDERR "detected ", $columns, " columns\n";

    # Create separate CSV file for each table.

    my $file_name = $table_title;
    $file_name =~ s/.*?:\s*(\S.*)/$1/;
    $file_name =~ s/\s+/-/g;    
    my $table_name = $file_name;
    $file_name .= '.csv';
    my $csv = Text::CSV::Encoded->new({encoding => undef, binary => 1});
    my $f = IO::File->new();
    $f->open("$file_name", ">");
    #$f->binmode(":encoding(UTF-8)");

    # Output all rows.

    # Each record specifies columns of F/M ratio, F/M ratio truncated and
    # rank.
    
    my %table_info = (
        'Enrolment-in-primary-education' => [3, 4, 5],
        'Enrolment-in-secondary-education' => [3, 4, 5],
        'Enrolment-in-tertiary-education' => [3, 4, 5],
        'Estimated-earned-income' => undef,
        'Healthy-life-expectancy' => [3, 4, 5],
        'Labour-force-participation' => [3, 4, 5],
        'Legislators,-senior-officials-and-managers' => [3, 4, 5],
        'Literacy-rate' => [3, 4, 5],
        'Professional-and-technical-workers' => [3, 4, 5],
        'Sex-ratio-at-birth' => undef,
        'Wage-equality-survey' => [2, 3, 4],
        'Women-in-ministerial-positions' => [3, 4, 5],
        'Women-in-parliament' => [3, 4, 5],
        'Years-with-female-head-of-state' => [3, 4, 5]
        );

    my $size = scalar @value_text;
    for (my $i = 0; $i < $size; $i += $columns) {
        my @row = @value_text[$i..($i + $columns - 1)];
        #print STDERR "row: ", Dumper(\@row), "\n";

        if ($table_name eq 'Estimated-earned-income') {
            $row[1] =~ s/,//g;
            $row[2] =~ s/,//g;
            $row[3] =~ s/,//g;
            $row[4] =~ s/,//g;
        }

        # Try to compute ratio corrected for instances where F/M ratio > 1.
        if (exists $table_info{$table_name}
            && defined $table_info{$table_name}) {
            my @cols = @{$table_info{$table_name}};
            my $fmr = $row[$cols[0]];
            my $orig_fmr = $fmr;
            my $diff = 0;
            if ($fmr =~ /$RE{num}{real}/) {
                $fmr += 0.0;
                if ($fmr > 1) {
                    $fmr = 1.0 / $fmr;
                }
                $diff = $fmr - $orig_fmr;
                if ($diff != 0) {
                    print STDERR ("", $row[0], ": ", $orig_fmr, " -> ", (sprintf "%5.2f", $fmr),
                                  " (delta ", (sprintf "%5.2f", $diff), ")\n");
                }
            }
            push @row, $fmr;
            #push @row, $diff;
        }
        
        $csv->print($f, \@row);
        print $f "\n";
    }
}
```

The script uses `gggr.xml` file as its input. This file was produced by the following command:

```bash
pdftohtml -f $((52+8)) -l $((65+8)) -c -s -noframes -xml -enc UTF-8  gggr2015.pdf gggr
```

The `gggr2015.pdf` file can be [downloaded](http://reports.weforum.org/global-gender-gap-report-2015/) from World Economic Forum web site.
